# Техническая документация AEP Downgrader

## Введение

AEP Downgrader - это инструмент для конвертации файлов Adobe After Effects (.aep) из более новых версий в более старые. Проект использует глубокий анализ структуры файлов RIFX (вариант формата RIFF с big-endian порядком байтов) для безопасной модификации версионных данных.

## Структура файлов .aep

Файлы .aep используют формат RIFX (Resource Interchange File Format с big-endian байтовым порядком), который состоит из:

- Сигнатуры: "RIFX"
- Размера файла (4 байта, big-endian)
- Формата: "Egg!" (для .aep файлов)
- Последовательности чанков, каждый из которых содержит:
  - Идентификатор чанка (4 байта)
  - Размер данных чанка (4 байта, big-endian)
  - Данные чанка
  - При необходимости, байт выравнивания (если размер нечетный)

### Ключевые чанки

1. **head** - содержит основную информацию о версии After Effects
2. **nhed** - содержит дополнительные заголовочные данные
3. **nnhd** - содержит информацию о количестве композиций и других элементах
4. **LIST** - содержит основные данные проекта

## Определение версии файла

### Методы исследования

Для определения различий между версиями мы провели следующие исследования:

1. **Сравнительный анализ** файлов разных версий AE
2. **Байтовый анализ** структуры заголовочных чанков
3. **Идентификация ключевых байтов**, отличающих версии

### Ключевые байты для определения версии

На основе анализа файлов различных версий AE мы определили, что ключевые различия находятся в чанке `head` на следующих позициях (относительно начала данных чанка):

- Позиция 1: Основной идентификатор версии
- Позиция 3: Дополнительный идентификатор
- Позиция 4: Тип проекта
- Позиция 5: Дополнительная информация
- Позиция 6: Контрольная сумма/идентификатор
- Позиция 7: Дополнительный флаг

### Известные сигнатуры версий

| Версия | Байты [1,3,4,5,6,7] | Hex |
|--------|---------------------|-----|
| AE 25.x | [0x60, 0x01, 0x0f, 0x08, 0x86, 0x44] | [96, 1, 15, 8, 134, 68] |
| AE 24.x | [0x5f, 0x05, 0x0f, 0x02, 0x86, 0x34] | [95, 5, 15, 2, 134, 52] |
| AE 23.x | [0x5e, 0x09, 0x0b, 0x3b, 0x06, 0x37] | [94, 9, 11, 59, 6, 55] |
| AE 22.x | [0x5d, 0x2b, 0x0b, 0x33, 0x06, 0x3b] | [93, 43, 11, 51, 6, 59] |

Обратите внимание, что первый байт уменьшается с увеличением версии: 0x60 (25) → 0x5f (24) → 0x5e (23) → 0x5d (22).

## Процесс конвертации

### Алгоритм преобразования

1. **Чтение файла**: Открываем .aep файл в бинарном режиме
2. **Анализ заголовков**: Извлекаем данные из чанка `head`
3. **Определение версии**: Сравниваем с известными сигнатурами
4. **Преобразование сигнатуры**: Заменяем байты на соответствующие целевой версии
5. **Запись результата**: Сохраняем модифицированный файл

### Позиционирование байтов

Для точного изменения байтов в файле мы используем следующие смещения:

- Начало данных чанка `head`: 32 байта от начала файла
- Позиции для изменения: [1, 3, 4, 5, 6, 7] относительно начала данных чанка
- Итоговые смещения в файле: 32 + [1, 3, 4, 5, 6, 7] = [33, 35, 36, 37, 38, 39]

## История исследований

### Этап 1: Анализ структуры файла

Первоначально мы определили, что .aep файлы используют формат RIFX, а не стандартный RIFF. Это позволило правильно интерпретировать размеры чанков и данные.

### Этап 2: Сравнение файлов разных версий

Мы сравнили файлы, созданные в AE 22.x, 23.x, 24.x и 25.x, чтобы найти различия в структуре. Ключевое открытие было сделано при анализе заголовочных чанков.

### Этап 3: Идентификация ключевых байтов

После детального анализа мы определили, что 6 конкретных байтов в чанке `head` уникально идентифицируют версию After Effects.

### Этап 4: Тестирование конверсии

Мы протестировали различные комбинации преобразований и проверили, открываются ли результаты в целевых версиях AE.

### Этап 5: Обнаружение проблем с AE 22.x

При тестировании конверсии в AE 22.x были обнаружены структурные различия, приводящие к ошибкам при открытии файлов. На основе этих наблюдений было принято решение исключить поддержку AE 22.x из-за потенциальных проблем совместимости.

## Использованные ресурсы

Этот проект частично основан на исследованиях, проведенных в репозитории [aep-parser](https://github.com/uwe-mayer/aep-parser), который предоставил ценные сведения о структуре .aep файлов.

## Ограничения

1. **Поддерживаемые версии**: В настоящее время поддерживаются только преобразования в AE 24.x и AE 23.x
2. **Структурные различия**: Некоторые сложные проекты могут содержать структурные особенности, специфичные для версии
3. **Плагины**: Эффекты и плагины, недоступные в целевой версии, могут вызвать проблемы

## Будущие улучшения

1. **Расширенная поддержка**: Возможность обработки дополнительных структурных различий между версиями
2. **Проверка целостности**: Добавление проверок для обеспечения корректности конвертированных файлов
3. **Поддержка дополнительных версий**: Расширение поддержки после дальнейших исследований